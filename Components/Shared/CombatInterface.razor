@using LoDCompanion.Services.Player
@using LoDCompanion.Services.Game
@using LoDCompanion.Services.Dungeon
@using LoDCompanion.Models.Character
@using LoDCompanion.Models

@inject CombatManagerService CombatManager

<div class="combat-interface-container">
    <div class="combat-log-wrapper">
        <h3>Combat Log</h3>
        <div class="combat-log">
            @foreach (var message in CombatManager.CombatLog.TakeLast(10))
            {
                <div class="log-entry">@message</div>
            }
        </div>
    </div>

    @if (CombatManager.ActiveHero != null)
    {
        <div class="player-action-bar">
            <h4>@CombatManager.ActiveHero.Name's Turn (@CombatManager.ActiveHero.CurrentAP AP)</h4>
            @if (!string.IsNullOrEmpty(FeedbackMessage))
            {
                <div class="feedback-message">@FeedbackMessage</div>
            }

            <div class="action-buttons">
                <button class="action-button end-turn" @onclick="() => OnActionButtonClicked.InvokeAsync(ActionType.EndTurn)">End Turn</button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string FeedbackMessage { get; set; } = string.Empty;
    [Parameter]
    public EventCallback<ActionType> OnActionButtonClicked { get; set; }

    protected override void OnInitialized()
    {
        CombatManager.OnCombatStateChanged += StateHasChanged;
    }

    public void Dispose()
    {
        CombatManager.OnCombatStateChanged -= StateHasChanged;
    }
}