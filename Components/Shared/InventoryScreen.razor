@using LoDCompanion.Models
@using LoDCompanion.Models.Character
@using LoDCompanion.Services.Player
@using LoDCompanion.Services.Game
@rendermode InteractiveServer

@inject UIService UIService
@inject PartyManagerService PartyManager
@inject InventoryService Inventory

<style>
    .inventory-backdrop {
        position: fixed; /* Position relative to the whole screen */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* Dim the background */
        z-index: 1050; /* A high value to ensure it's on top */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .inventory-container {
        background-color: #2c251e;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #5a4d3a;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        color: #f0e6d2;
        min-width: 500px;
    }

    .inventory-slot {
    width: 80px;
    height: 80px;
    border: 2px solid #5a4d3a;
    background-color: #4a3f30;
    padding: 4px;
    position: relative;
    color: #f0e6d2;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal;
    }

    .slot-content {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .empty-slot {
    background-color: #3e3529;
    color: #8c7a60;
    }

    .item-name {
    flex-grow: 1;
    display: flex;
    align-items: center;
    padding-top: 15px; /* Add padding to avoid overlap with button */
    }

    .slot-action-button {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    border: 1px solid #1a1a1a;
    border-radius: 50%;
    color: white;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    }

    .equip {
    background-color: #198754; /* Green */
    }

    .unequip {
    background-color: #dc3545; /* Red */
    }

    .item-quantity {
    font-size: 10px;
    position: absolute;
    bottom: 2px;
    right: 4px;
    background: rgba(0,0,0,0.5);
    padding: 1px 3px;
    border-radius: 4px;
    }

    .inventory-grid {
    display: grid;
    gap: 8px;
    margin-bottom: 20px;
    }

    .equipped-grid {
    grid-template-columns: repeat(4, 1fr); /* 4 columns for equipped items */
    }

    .backpack-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Responsive grid */
    max-height: 300px;
    overflow-y: auto;
    padding: 5px;
    background-color: #3e3529;
    border: 1px solid #5a4d3a;
    }

    .slot-icon {
        position: absolute;
        top: 2px;
        left: 2px;
        font-size: 16px;
        line-height: 1;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    img.slot-icon {
        width: 20px;
        height: 20px;
        object-fit: contain; /* Ensures the image scales nicely */
    }

</style>

@if (UIService.IsInventoryVisible && PartyManager.SelectedHero != null)
{
    var hero = PartyManager.SelectedHero;

    <div class="inventory-backdrop" @onclick="UIService.HideInventoryAsync">
        <div class="inventory-container" @onclick:stopPropagation>
            <h3>@hero.Name's Inventory</h3>

            <h4>Equipped</h4>
            <div class="inventory-grid equipped-grid">
                @RenderEquippedSlot(hero.Inventory.EquippedWeapon, "Weapon")
                @RenderEquippedSlot(hero.Inventory.OffHand, "Off-Hand")
                @RenderEquippedSlot(hero.Inventory.EquippedQuiver, "Quiver")
                @foreach(var item in hero.Inventory.QuickSlots)
                {
					@RenderEquippedSlot(item, "Quick Slot")
                }
                
                @{
                    var cloakItems = GetEquippedArmourBySlot(hero, ArmourProperty.Cloak);
                }
                @if (cloakItems != null)
                {
                    @RenderEquippedSlot(cloakItems.FirstOrDefault(), "Cloak", ArmourProperty.Cloak)
                    @RenderEquippedSlot(cloakItems.Skip(1).FirstOrDefault(), "Cloak", ArmourProperty.Cloak)
                }

                @{
                    var headItems = GetEquippedArmourBySlot(hero, ArmourProperty.Head);
                }
                @if (headItems != null)
                {
                    @RenderEquippedSlot(headItems.FirstOrDefault(), "Head", ArmourProperty.Head)
                    @RenderEquippedSlot(headItems.Skip(1).FirstOrDefault(), "Head", ArmourProperty.Head)
                }

                @{
                    var torsoItems = GetEquippedArmourBySlot(hero, ArmourProperty.Torso);
                }
                @if (torsoItems != null)
                {
                    @RenderEquippedSlot(torsoItems.FirstOrDefault(), "Torso", ArmourProperty.Torso)
                    @RenderEquippedSlot(torsoItems.Skip(1).FirstOrDefault(), "Torso", ArmourProperty.Torso)
                }

                @{
                    var armItems = GetEquippedArmourBySlot(hero, ArmourProperty.Arms);
                }
                @if (armItems != null)
                {
                    @RenderEquippedSlot(armItems.FirstOrDefault(), "Arms", ArmourProperty.Arms)
                    @RenderEquippedSlot(armItems.Skip(1).FirstOrDefault(), "Arms", ArmourProperty.Arms)
                }

                @{
                    var legItems = GetEquippedArmourBySlot(hero, ArmourProperty.Legs);
                }
                @if (legItems != null)
                {
                    @RenderEquippedSlot(legItems.FirstOrDefault(), "Legs", ArmourProperty.Legs)
                    @RenderEquippedSlot(legItems.Skip(1).FirstOrDefault(), "Legs", ArmourProperty.Legs)
                }
            </div>

            <h4>Backpack</h4>
            <div class="inventory-grid backpack-grid">
                @foreach (var item in hero.Inventory.Backpack.OrderBy(i => i.Name))
                {
                    <div class="inventory-slot">
                        <button class="slot-action-button equip" @onclick="() => EquipItem(item)">+</button>
                        <div class="item-name">@item.Name</div>
                        @if (item.Quantity > 1)
                        {
                            <div class="item-quantity">x @item.Quantity</div>
                        }
                    </div>
                }
            </div>

            <button class="close-button" @onclick="UIService.HideInventoryAsync">Close</button>
        </div>
    </div>
}

@code {
    /// <summary>
    /// A helper method to render a single equipment slot. It dynamically creates
    /// the HTML for either an occupied slot with an unequip button or an empty slot.
    /// </summary>
    /// <param name="item">The equipment to display, which can be null.</param>
    /// <param name="slotName">The name of the slot to display if it's empty.</param>
    private RenderFragment RenderEquippedSlot(Equipment? item, string slotName, ArmourProperty? slotContext = null) => builder =>
    {
        if (item != null)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "inventory-slot");
            builder.AddAttribute(2, "title", $"{item.ToString()}");

            // --- All absolutely positioned items go here ---

            if (slotContext.HasValue && item is Armour)
            {
                // Get the icon for the specific slot being rendered
                var icon = GetIconForSlot(slotContext.Value);

                if (!string.IsNullOrEmpty(icon))
                {
                    builder.OpenElement(2, "img");
                    builder.AddAttribute(3, "class", "slot-icon");
                    builder.AddAttribute(4, "src", icon);
                    builder.CloseElement();
                }
            }

            // Unequip Button (Upper-Right)
            builder.OpenElement(5, "button");
            builder.AddAttribute(6, "class", "slot-action-button unequip");
            builder.AddAttribute(7, "onclick", EventCallback.Factory.Create(this, () => UnequipItem(item)));
            builder.AddContent(8, "-");
            builder.CloseElement();

            // Quantity (Lower-Right)
            if (item.Quantity > 1)
            {
                builder.OpenElement(9, "div");
                builder.AddAttribute(10, "class", "item-quantity");
                builder.AddContent(11, $"x {item.Quantity}");
                builder.CloseElement();
            }

            // --- Wrapper for the centered content ---
            builder.OpenElement(12, "div");
            builder.AddAttribute(13, "class", "slot-content");

            builder.OpenElement(14, "div");
            builder.AddAttribute(15, "class", "item-name");
            builder.AddContent(16, item.Name);
            builder.CloseElement(); // item-name

            builder.CloseElement(); // slot-content
            builder.CloseElement(); // inventory-slot
        }
        else
        {
            // If the slot is empty, show its name.
            builder.OpenElement(17, "div");
            builder.AddAttribute(18, "class", "inventory-slot empty-slot");
            builder.AddContent(19, slotName);
            builder.CloseElement();
        }
    };

    /// <summary>
    /// Finds the first piece of equipped armor that corresponds to a given body slot.
    /// </summary>
    /// <param name="hero">The hero whose armor to check.</param>
    /// <param name="slot">The ArmourProperty representing the body slot (e.g., Head, Torso).</param>
    /// <returns>The equipped Armour object or null if no item is in that slot.</returns>
    private List<Armour>? GetEquippedArmourBySlot(Hero hero, ArmourProperty slot)
    {
        return hero.Inventory.EquippedArmour.Where(a => a.HasProperty(slot)).ToList();
    }

    private string GetIconForSlot(ArmourProperty slot)
    {
        switch (slot)
        {
            case ArmourProperty.Head: return "/Resources/MedievalKingdomUI/UI_icons/Equipment/icon_alpha_helm.png";
            case ArmourProperty.Torso: return "/Resources/MedievalKingdomUI/UI_icons/Equipment/icon_alpha_chest.png";
            case ArmourProperty.Legs: return "/Resources/MedievalKingdomUI/UI_icons/Equipment/icon_alpha_pants.png";
            case ArmourProperty.Arms: return "/Resources/MedievalKingdomUI/UI_icons/Equipment/icon_alpha_bracers.png";
            case ArmourProperty.Cloak: return "/Resources/MedievalKingdomUI/UI_icons/Equipment/icon_alpha_back.png";
            default: return string.Empty; // Return nothing if no specific icon is found
        }
    }

    private void EquipItem(Equipment item)
    {
        if (PartyManager.SelectedHero != null)
        {
            Inventory.EquipItem(PartyManager.SelectedHero, item);
        }
    }

    private void UnequipItem(Equipment item)
    {
        if (PartyManager.SelectedHero != null)
        {
            Inventory.UnequipItem(PartyManager.SelectedHero, item);
        }
    }

    private async Task OnStateChangedHandler()
    {
        // InvokeAsync marshals the call to StateHasChanged to the correct UI thread.
        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        UIService.OnStateChanged += OnStateChangedHandler;
        PartyManager.OnPartyChanged += StateHasChanged;
    }

    public void Dispose()
    {
        UIService.OnStateChanged -= OnStateChangedHandler;
        PartyManager.OnPartyChanged -= StateHasChanged;
    }
}